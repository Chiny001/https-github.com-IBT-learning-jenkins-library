pipeline {
    agent any
    tools { maven  'maven_3.8' }
    stages {
        stage('Git checkout') {
            steps {
                checkout changelog: false, poll: false, scm: scmGit(branches: [[name: '*/feauture/theodoreatabe']], extensions: [], userRemoteConfigs: [[credentialsId: 'jenkins-pw-credential', url: 'https://github.com/IBT-learning/ibt-maven.git']])
            }
        }
        stage ('validate'){
            steps {
               sh 'mvn validate'
            }
        }
         stage ('compile'){
                     steps {
                        sh 'mvn compile'
                     }
                 }
                 stage('SonarQube Analysis') {
                   environment {
                             sonarScan = tool 'ibt-sonarqube'
                         }
                   steps {
                     withSonarQubeEnv(credentialsId: 'ibt-sonar', installationName: 'IBT sonarqube') {
                       sh "${env.sonarScan}/bin/sonar-scanner"
                              }
                             }
                            }
                           stage ('test'){
                            steps {
                               sh 'mvn test'
                            }
                        }
            stage ('package'){
                                        steps {
                                           sh 'mvn package'
                                        }
                                    }
             stage('Vulnerability scan - Dependency check'){
                 steps {
                            dependencyCheck additionalArguments:'''
                                 -o "./"
                                 -o "./"
                                 -f "ALL"
                                 --prettyPrint ''', odcInstallation: 'dependency-check'
                           dependencyCheckPublisher pattern: 'dependency-check-report.xml'
                 }
             }
             stage('Upload to Artifactory(secret file)'){
                 steps {
                     withCredentials([file(credentialsId: 'mvn-settings-theodore4G', variable: 'theodore4G')]) {
                         sh 'mvn deploy -s $theodore4G'
                     }
                     withCredentials([usernamePassword(credentialsId: 'jenkins-pw-credential', passwordVariable: 'art_password', usernameVariable: 'art_name')]) {
                         sh 'echo $art_name $art_password'
                     }
                 }
             }
             stage('Upload to Artifactory (config-file)'){
                 steps{
                     configFileProvider([configFile(fileId: 'artifactory-settings', variable: 'maven_settings_artifactory')]) {
                        sh 'mvn deploy -s $maven_settings_artifactory'
                     }
                 }
             }
             stage('Deploy to Dev')
             {
                 steps{
                       script{
                          def remote = [name: 'dev-server',host: '137.184.228.108', allowAnyHosts: true]
                          withCredentials([usernamePassword(credentialsId: 'server-ssh-pwd', passwordVariable: 'password', usernameVariable: 'username')]) {
                             remote.user = username
                             remote.password = password
                             sshPut remote: remote, from: 'target/ibt-maven-1.2-SNAPSHOT.jar' , into: '/opt/tomcat/apps'

                          }
                       }
                 }
             }
    }
}